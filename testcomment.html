<!DOCTYPE html>
<html>
<head>
<title>Page Title</title>

<script src='https://cdnjs.cloudflare.com/ajax/libs/tabletop.js/1.5.1/tabletop.min.js'></script>
<script type='text/javascript'>    
  var publicSpreadsheetUrl = 'https://docs.google.com/spreadsheets/d/1y2pe9-kgELYp8gUHu6fjGOClm2XT1QcBXCufXD4Hjxc/edit?usp=sharing';

  function init() {
    Tabletop.init( { key: publicSpreadsheetUrl,
                     callback: parseSpreadsheet,
                     simpleSheet: true } )
  }

  function parseSpreadsheet(data, tabletop) {
    alert('Successfully processed!');

// Tabletop returns objects as rows, we need to recombine them into arrays of columns
// https://github.com/jsoma/tabletop/issues/170#issuecomment-538659494
// Get the keys
const keys = Object.keys(data[0]);
// Turn them into a list of objects
const mapped = keys.map( function(key) {
    // Get the key's value for each existing object, only keep non-empty ones
    return ({ [key]: data.map( o => o[key] ).filter( value => value ) });
})
// Turn that list into a global object
commentData = Object.assign(...mapped);


    // console.log(commentData);

 // alert(commentData['week'][0]);

  }

  window.addEventListener('DOMContentLoaded', init)
</script>


</head>
<body>

<p id="demo"></p>

<button onclick="comment()">Click me</button>

<script>
function comment()
{
  // the string that will contain the comment
  var theComment = "";

  // determine arrangement of comment
  // for now only one arrangement. In future, array of arrays (?)
  var order = ['week','personal','focus','positive','closer'];

  // loop through order, selecting a random commentData and adding it to theComment
  for (let i = 0; i < order.length; i++)
  {
    // if week first, wee need to add the name first.
    if ((i === 0) && (order[i] === "week")) theComment += "Alexandra ";

    // if personal and week are neighours we need to add an " and " in between them
    if (((order[i] === "personal") && (order[i-1] === "week")) || ((order[i] === "week") && (order[i-1] === "personal")))  theComment += " and ";

    // when we hit i === 2 we need to add a full stop, always.
    if (i === 2) theComment += ". ";

    /////// Main comment adder /////// 

    theComment += commentData[order[i]][Math.floor(Math.random() * commentData[order[i]].length)];

   /////// Main comment adder /////// 

    // after adding to the comment, when we hit "focus" we need some logic to determine which skill to talk about after. for now, just go to "fluency"
    if (order[i] === "focus") theComment += ". " + commentData["fluency"][Math.floor(Math.random() * commentData["fluency"].length)] + ". ";

    // if positive is first, we need to add the name after, otherwise, just a full stop.
    if ((i === 0) && (order[i] === "positive")) theComment += "Alexandra";
    else if (order[i] === "positive") theComment += ". ";


    // after the closer, we need to add some punctuation
    if (order[i] === "closer")
    {
      if (Math.random() > 0.5) theComment += "!";
      else theComment += ".";
    } 
  } // End of compiling comment.

  // capitalise first letter after full stop.
  function capitalise(str) 
{
    str = str.split(". ");

    for (var i = 0, x = str.length; i < x; i++) {
        str[i] = str[i][0].toUpperCase() + str[i].substr(1);
    }

    return str.join(". ");
}

  theComment = capitalise(theComment);


  // parse template literals


  // FINALLY print out results
  document.getElementById("demo").innerHTML = theComment;
}
</script>



</body>
</html>
